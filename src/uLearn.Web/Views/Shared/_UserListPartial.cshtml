@using Database.Models
@using uLearn.Extensions
@model UserListModel

@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "AntiForgeryTokenContainer" }))
{
	@Html.AntiForgeryToken()
}

<table class="table table-condensed">
	<tr>
		<th>Логин</th>
		<th>Имя</th>
		<th>Группы</th>
		@if (Model.IsCourseAdmin)
		{
			<th>Роли</th>
			<th>Права</th>
		}
		@if (Model.ShowDangerEntities)
		{
			<th>Удаление</th>
		}
	</tr>
	@foreach (var user in Model.Users)
	{
		<tr data-userid="@user.UserId">
			<td>@Html.ActionLink(user.UserName, "Info", "Account", new { userName = user.UserName }, new { })</td>
			<td>@user.UserVisibleName</td>
			<td>@Model.UsersGroups.GetOrDefault(user.UserId, "")</td>
			@if (Model.IsCourseAdmin)
			{
				<td>
					<div class="btn-group">
						@if (Model.ShowDangerEntities)
						{
							@RoleButton(user, LmsRoles.SysAdmin, "danger")
						}
						@RoleButton(user, CourseRole.CourseAdmin, "warning")
						@RoleButton(user, CourseRole.Instructor, "info")
						@RoleButton(user, CourseRole.Tester, "success")
					</div>
				</td>
				<td>
					@AccessButtons(user)
				</td>
			}
			@if (Model.ShowDangerEntities)
			{
				<td>
					@using (Html.BeginForm("DeleteUser", "Account", new { userId = user.UserId }, FormMethod.Post))
					{
						@Html.AntiForgeryToken()
						<button type="submit" class="btn btn-sm btn-danger">Удалить пользователя</button>
					}
				</td>
			}
		</tr>
	}
</table>

@helper RoleButton(UserModel user, CourseRole role, string cssClass)
{
	@RoleButton(user, role.ToString(), cssClass)
}

@helper RoleButton(UserModel user, string role, string cssClass)
{
	if (user.CourseRoles.ContainsKey(role))
	{
		@RoleButton((dynamic)user.CourseRoles[role], role, cssClass)
	}
}

@helper RoleButton(SingleCourseRolesModel courseRoles, string role, string cssClass)
{
	var buttonClass = "btn-" + cssClass;
	<button type="button"
			class="btn btn-sm btn-default @( courseRoles.HasAccess ? buttonClass : "")"
			data-css-class="@buttonClass"
			data-toggle-url="@courseRoles.ToggleUrl"
			onclick="ToggleRole(event, this, ToggleButtonClass)">
		@role
	</button>
}

@helper RoleButton(ManyCourseRolesModel coursesRoles, string role, string cssClass)
{
	var buttonClass = "btn-" + cssClass;
	var liClass = "li-" + cssClass;
	var hasAccess = coursesRoles.CourseRoles.Any(model => model.HasAccess);
	<div class="btn-group">
		<button type="button"
				class="btn btn-sm  btn-default dropdown-toggle @( hasAccess ? buttonClass : "")"
				data-css-class="@buttonClass"
				data-toggle="dropdown"
				aria-haspopup="true"
				aria-expanded="false">
			@role <span class="caret"></span>
		</button>
		<ul class="dropdown-menu" data-css-class="li-@cssClass">
			@foreach (var course in coursesRoles.CourseRoles)
			{
				<li class="@( course.HasAccess ? liClass : "")"
					data-toggle-url="@course.ToggleUrl"
					onclick="ToggleRole(event, this, ToggleDropDownClass)">
					<a>@course.CourseId</a>
				</li>
			}
		</ul>
	</div>
}

@helper AccessButtons(UserModel user)
{
	var buttonClass = "btn-primary";
	<div class="btn-group">
		<button type="button"
				class="btn btn-sm  btn-default dropdown-toggle"
				data-css-class="@buttonClass"
				data-toggle="dropdown"
				aria-haspopup="true"
				aria-expanded="false">
			Права <span class="caret"></span>
		</button>
		<ul class="dropdown-menu" data-css-class="li-primary">
			@foreach (var courseAccessType in user.CourseAccesses.Keys)
			{
				var courseAccess = user.CourseAccesses[courseAccessType];
				<li class="@( courseAccess.HasAccess ? "li-primary" : "")"
					data-toggle-url="@courseAccess.ToggleUrl"
					onclick="ToggleRole(event, this, ToggleDropDownClass)">
					<a>@courseAccessType.GetDisplayName()</a>
				</li>
			}
		</ul>
	</div>
}
